<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Đếm thở Khí Công AI</title>
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; text-align: center; padding: 20px; background-color: #f0f2f5; color: #333; }
  h2 { color: #2c3e50; }
  
  /* Khung nhập liệu đẹp hơn */
  .control-group { margin: 20px 0; }
  input { padding: 10px; width: 70px; text-align: center; font-size: 20px; border-radius: 8px; border: 1px solid #ccc; outline: none; transition: 0.3s; }
  input:focus { border-color: #007bff; box-shadow: 0 0 5px rgba(0,123,255,0.3); }
  label { font-size: 16px; display: block; margin-bottom: 5px; color: #666; }

  /* Nút bấm xịn hơn */
  .btn-container { margin-top: 30px; }
  button { padding: 15px 30px; margin: 10px; cursor: pointer; font-size: 18px; border-radius: 50px; border: none; color: white; transition: transform 0.1s, box-shadow 0.2s; font-weight: bold; }
  button.start { background: linear-gradient(135deg, #007bff, #0056b3); box-shadow: 0 4px 15px rgba(0,123,255,0.4); }
  button.stop { background: linear-gradient(135deg, #dc3545, #a71d2a); box-shadow: 0 4px 15px rgba(220,53,69,0.4); }
  button:active { transform: scale(0.95); }

  /* Hiển thị số to */
  #status { font-size: 32px; margin-top: 40px; font-weight: bold; color: #444; height: 50px; }
  #counter { font-size: 120px; line-height: 1; color: #007bff; margin: 10px 0; font-weight: 800; text-shadow: 2px 2px 0px #fff, 4px 4px 0px rgba(0,0,0,0.1); }
  
  .ratio-info { background: #e9ecef; padding: 10px 20px; display: inline-block; border-radius: 20px; margin-bottom: 20px; font-weight: 500; color: #555; }
  .tutorial { font-size: 14px; color: #888; margin-top: 50px; }
</style>
</head>
<body>

<h2>Bài tập thở Thải Độc</h2>
<div class="ratio-info">Tỷ lệ: Hít (1) - Thở (2)</div>

<div class="control-group">
    <label>Hít vào (giây)</label>
    <input id="n" type="number" value="5" min="1">
</div>

<div class="control-group">
    <label>Tổng thời gian (phút)</label>
    <input id="minutes" type="number" value="10" min="1">
</div>

<div id="status">Sẵn sàng</div>
<div id="counter">--</div>

<div class="btn-container">
    <button class="start" onclick="start()">BẮT ĐẦU</button>
    <button class="stop" onclick="stop()">DỪNG</button>
</div>

<p class="tutorial">Lưu ý: Cần có thư mục <b>sounds</b> chứa file mp3 (hit, tho, 1, 2, 3...)</p>

<audio id="audioPlayer"></audio>

<script>
let timer = null;       
let currentCount = 1;   
let phaseIndex = 0;     // 0: Hít, 1: Thở
let phaseLimit = 0;     
let endTime = 0;

// Cấu hình pha: name phải trùng tên file mp3 (hit.mp3, tho.mp3)
const phases = [
    { name: "hit", label: "Hít vào", ratio: 1 },
    { name: "tho", label: "Thở ra", ratio: 2 }
];

const audioPlayer = document.getElementById('audioPlayer');

// Hàm phát âm thanh an toàn (không lỗi nếu thiếu file)
function playSound(filename) {
    const path = `sounds/${filename}.mp3`;
    audioPlayer.src = path;
    audioPlayer.playbackRate = 1.0; 
    
    // Nếu file không tồn tại hoặc lỗi mạng, nó sẽ log lỗi ra console chứ không làm đơ web
    audioPlayer.play().catch(e => {
        console.log("Không tìm thấy file hoặc chưa tương tác: " + filename);
    });
}

function updateDisplay(text, countDisplay) {
  document.getElementById("status").innerText = text;
  document.getElementById("counter").innerText = countDisplay;
  
  // Đổi màu chữ theo pha cho sinh động
  const counterEl = document.getElementById("counter");
  if (text.includes("Hít")) counterEl.style.color = "#28a745"; // Xanh lá
  else if (text.includes("Thở")) counterEl.style.color = "#007bff"; // Xanh dương
  else counterEl.style.color = "#333";
}

function tick() {
  if (Date.now() >= endTime) {
    stop();
    playSound("xong");
    updateDisplay("Hoàn thành", "OK");
    return;
  }

  const currentPhaseConfig = phases[phaseIndex];

  // Logic: Giây 1 đọc lệnh, Giây 2+ đọc số
  if (currentCount === 1) {
    playSound(currentPhaseConfig.name); 
    updateDisplay(currentPhaseConfig.label, currentPhaseConfig.name.toUpperCase());
  } else {
    // Vì file mp3 của bạn là "Hai mốt", "Hai lăm" nên chỉ cần gọi số
    playSound(currentCount); 
    updateDisplay(currentPhaseConfig.label, currentCount);
  }

  currentCount++;

  if (currentCount > phaseLimit) {
    switchPhase();
  }
}

function switchPhase() {
  phaseIndex = (phaseIndex + 1) % 2;
  currentCount = 1; 
  const baseTime = parseInt(document.getElementById("n").value);
  phaseLimit = baseTime * phases[phaseIndex].ratio;
}

function start() {
  if (timer) return; 

  const minutes = parseInt(document.getElementById("minutes").value);
  endTime = Date.now() + minutes * 60 * 1000;
  
  phaseIndex = 0; 
  currentCount = 1; 
  const baseTime = parseInt(document.getElementById("n").value);
  phaseLimit = baseTime * phases[0].ratio;

  // Kích hoạt âm thanh lần đầu (cho iOS)
  audioPlayer.src = "";
  audioPlayer.play().catch(() => {});

  tick();
  timer = setInterval(tick, 1000);
}

function stop() {
  clearInterval(timer);
  timer = null;
  audioPlayer.pause();
  updateDisplay("Đã dừng", "--");
}
</script>

</body>
</html>